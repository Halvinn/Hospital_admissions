---
title: "Hospital Admissions"
author: "Onesmas Ngugi"
date: "April 4, 2018"
output: html_document
---
# INTRODUCTION

The Statewide Planning and Research Cooperative System (SPARCS) Inpatient De-identified File contains discharge level detail on patient characteristics, diagnoses, treatments, services, and charges. This data file contains basic record level detail for the discharge. The de-identified data file does not contain data that is protected health information (PHI) under HIPAA. The health information is not individually identifiable; all data elements considered identifiable have been redacted. For example, the direct identifiers regarding a date have the day and month portion of the date removed.



# Libraries and Data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, cache=TRUE)
```

```{r message=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
```
```{r, eval = FALSE}
# Url for data dowload. I saved the cvs file locally to avoid dowloading each time
# I reload the script.
url <- "https://health.data.ny.gov/api/views/gnzp-ekau/rows.csv?accessType=DOWNLOAD"
download.file(url, "hosp_discharges.csv")
```
```{r}
discharges <- read_csv("hosp_discharges.csv", col_types = cols(
  `Health Service Area` = col_character(),
  `Hospital County` = col_character(),
  `Operating Certificate Number` = col_character(),
  `Facility Id` = col_integer(),
  `Facility Name` = col_character(),
  `Age Group` = col_character(),
  `Zip Code - 3 digits` = col_character(),
  Gender = col_character(),
  Race = col_character(),
  Ethnicity = col_character(),
  `Length of Stay` = col_double(),
  `Type of Admission` = col_character(),
  `Patient Disposition` = col_character(),
  `Discharge Year` = col_integer(),
  `CCS Diagnosis Code` = col_integer(),
  `CCS Diagnosis Description` = col_character(),
  `CCS Procedure Code` = col_integer(),
  `CCS Procedure Description` = col_character(),
  `APR DRG Code` = col_integer(),
  `APR DRG Description` = col_character(),
  `APR MDC Code` = col_integer(),
  `APR MDC Description` = col_character(),
  `APR Severity of Illness Code` = col_integer(),
  `APR Severity of Illness Description` = col_character(),
  `APR Risk of Mortality` = col_character(),
  `APR Medical Surgical Description` = col_character(),
  `Payment Typology 1` = col_character(),
  `Payment Typology 2` = col_character(),
  `Payment Typology 3` = col_character(),
  `Attending Provider License Number` = col_integer(),
  `Operating Provider License Number` = col_integer(),
  `Other Provider License Number` = col_integer(),
  `Birth Weight` = col_integer(),
  `Abortion Edit Indicator` = col_character(),
  `Emergency Department Indicator` = col_character(),
  `Total Charges` = col_double(),
  `Total Costs` = col_double()))
```

Let's explore the data.

```{r}
dim(discharges)
head(names(discharges))
```

'''
The dataset has `r count(discharges)` records and `r length(names(discharges))` columns.
The column names have spaces in them which makes working with them a bit cumbersome as quotes have to be used around column names everytime. We can rename the columns by replacing spaces with "_".
'''


## Missing Data

Let's look at which variables have missing data. Visualizations can be a good way
to quickly show 

```{r}
sort(sapply(discharges, function(x) sum(is.na(x))), decreasing = TRUE)
```
```{r}
missing_by_column <- discharges %>% 
    is.na %>%
    as_data_frame %>%
    mutate(row_number = 1:nrow(.)) %>%
    gather(variable, is_missing, -row_number)

head(missing_by_column)
```

```{r, eval = FALSE}
# Dataset is too large thus getting error " Cannot allocate vector of size nMB."
ggplot(missing_by_column, aes(x = variable, y = row_number, fill = is_missing)) +
    geom_raster() +
    scale_fill_grey(name = "",
                    labels = c("Present", "Mssing")) +
    theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
    labs(x = "Variable",
         y = "Rows / Observations")
```
```{r}
if (!require(Amelia)) {
    install.packages(("Amelia"))
}

library(Amelia)
missmap(discharges, col = c("grey", "black"), y.labels = NULL, y.at = NULL, x.cex = 0.6)
```

```{r}
filter(discharges, is.na(Facility_Name))
```

```{r}
count(filter(discharges, Abortion_Edit_Indicator == "Y"))
```

### Issues with Missing Data.
1. Column names have spaces. Should be replaced with "_". Easier to work with.
2. I record has all entries missing. No explanation found. This record should be deleted.
3. A few columns have a lot records missing. For example, 'Other_Provider_License_Number' 
column has more than 94% of record missing. This column can be dropped as there is no way to impute the missing data.
4. From further inspection, any record where Abortion_Edit_Indicator == "Y" has all 
information about the facility i.e Facility Name, Health Service Area, Hospital County
etc. removed for privacy purposes. No need to fix this issue.
5. Zip codes have first two digits removed for privacy purposes. Thus this column
is not useful as is.
6. 

### Fixes.
1. Replace spaces in column names with "_".
```{r}
col_names <- str_replace_all(names(discharges), pattern = " ", replacement = "_")
names(discharges) <- col_names
```

2. Drop row with missing info. Identified by missing Facility_Id.
3. Drop columns 'Other_Provider_License_Number' and 'Zip_Code'.

```{r}
discharges_clean <- discharges %>%
    select(-c("Other_Provider_License_Number", "Zip_Code_-_3_digits")) %>%
    filter(!is.na(Facility_Id))
```




